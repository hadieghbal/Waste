<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فرم هوشمند گزارش ضایعات</title>

    
    <!-- فایل‌های CSS محلی -->
    <link rel="stylesheet" href="assets/css/jdp.min.css">
    <link rel="stylesheet" href="assets/css/bootstrap-icons.min.css">
    <link rel="stylesheet" href="assets/css/choices.min.css"/>
    <!-- فایل JS محلی -->
    <script src="assets/js/html2canvas.min.js"></script>
    <style>
        /* تعریف فونت وزیرمتن به صورت محلی */
        @font-face {
            font-family: 'Vazirmatn';
            src: url('assets/fonts/vazirmatn/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('assets/fonts/vazirmatn/Vazirmatn-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('assets/fonts/vazirmatn/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --primary-color: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --info-color: #0aa7c4;
            --purple-color: #6f42c1;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --bg-color: #eef2f7;
            --form-bg-color: #ffffff;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --supplier-icon-color: #d63384;
            --source-icon-color: #6f42c1;
            --defect-icon-color: #0d6efd;
        }

        /* بقیه استایل‌های شما بدون تغییر در اینجا قرار می‌گیرد... */
        
        /* START: استایل‌های اختصاصی برای Choices.js */
        .choices { 
            font-family: 'Vazirmatn', sans-serif;
            margin-bottom: 0;
        }

        .choices__inner {
            background-color: #fff;
            border-radius: var(--border-radius);
            padding: 7px 12px;
            border: 1px solid var(--border-color);
            min-height: 48px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .is-focused .choices__inner, .is-open .choices__inner {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15);
        }
        .choices__list--dropdown { border-radius: var(--border-radius); }
        .choices__input { background-color: transparent !important; }
        tbody .choices__inner {
            background-color: transparent;
            border-radius: 4px;
            border: 1px solid transparent;
            min-height: auto;
            height: 40px;
            padding: 5px;
        }
        tbody .is-focused .choices__inner, tbody .is-open .choices__inner {
            background-color: #fff;
            border-color: var(--primary-color);
        }
        .choices[data-type*="select-one"]::after {
            border-color: var(--secondary-color) transparent transparent;
            right: auto;
            left: 20px;
            margin-top: -5px;
        }
        .choices.is-open[data-type*="select-one"]::after {
            border-color: transparent transparent var(--secondary-color);
            margin-top: -2.5px;
        }
        .choices__item--choice { text-align: right; }
        
        .mobile-form-group .choices {
            flex-grow: 1;
            min-width: 0; 
        }
    
        .mobile-form-group .choices__inner {
            width: 100%;
        }
        /* END: استایل‌های اختصاصی برای Choices.js */

        body {
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0; 
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1400px; 
            margin: auto;
            background-color: var(--form-bg-color);
            box-sizing: border-box;
            padding: 15px;
            box-shadow: none;
            border-radius: 0;
        }
        
        #exportable-area { }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            row-gap: 15px; 
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .header-center { display: flex; align-items: center; gap: 10px; order: -1; flex-basis: 100%; justify-content: center; }
        .header-center h1 { margin: 0; font-size: 22px; font-weight: 700; color: var(--primary-color); }
        .header-center i { font-size: 28px; color: var(--primary-color); }
        .header-left div { font-size: 12px; color: var(--secondary-color); }
        .header-right div { font-size: 14px; font-weight: 700; color: var(--secondary-color); }
        
        .top-controls {
            display: flex;
            flex-direction: column; 
            gap: 18px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-color: var(--light-color);
        }
        .form-meta { display: flex; align-items: center; gap: 10px; width: 100%; }
        .form-meta label { font-weight: 500; min-width: 80px; color: var(--secondary-color); white-space: nowrap; }
        .form-meta input, .form-meta select { border: 1px solid var(--border-color); padding: 10px 12px; border-radius: var(--border-radius); background-color: #fff; font-family: 'Vazirmatn', sans-serif; flex-grow: 1; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-meta input:focus, .form-meta select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15); }
        .waste-type-selector { display: flex; gap: 20px; justify-content: center; align-items: center; }
        .waste-type-selector label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        .top-controls .required-field-error { border-color: var(--danger-color) !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25); }
        
        .form-locked input, .form-locked select, .form-locked .counter-btn {
            background-color: #f0f0f0 !important; cursor: not-allowed !important; color: #777 !important; border-color: var(--border-color) !important; box-shadow: none !important;
        }

        .table-wrapper { display: none; overflow-x: auto; margin-top: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1600px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; vertical-align: middle; }
        thead th { background-color: #eaf2ff; font-weight: 700; position: sticky; top: 0; z-index: 2; color: var(--primary-color); }
        th[data-target-name] { cursor: pointer; background-color: #fffae6; }
        th[data-target-name]:hover { background-color: #ffeeb3; }
        .form-locked th[data-target-name] { cursor: not-allowed; }
        tbody tr { transition: background-color 0.2s; }
        tbody tr.active-row { background-color: #d1e7dd !important; }
        tbody tr:hover:not(.active-row):not(.invalid-row) { background-color: #f0f5ff !important; }
        tbody tr.invalid-row { background-color: #f8d7da !important; }
        tbody td { border: none; border-left: 1px solid var(--border-color); } 
        tbody td:last-child { border-left: none; }
        tbody td input, tbody td select { width: 100%; height: 40px; border: 1px solid transparent; background-color: transparent; text-align: center; padding: 5px; box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; border-radius: 4px; }
        tbody td input:focus, tbody td select:focus { outline: none; background-color: #fff; border-color: var(--primary-color); }
        .defects-summary-col input { text-align: right !important; padding-right: 5px !important; cursor: default !important; }
        .delete-row-btn { background: none; border: none; color: var(--danger-color); font-size: 20px; cursor: pointer; transition: transform 0.2s; }
        .delete-row-btn:hover { transform: scale(1.2); }
        
        .approvers-container {
            margin-top: 30px;
            padding: 20px;
            border: 1px dashed var(--purple-color);
            border-radius: var(--border-radius);
            background-color: #f8f7ff;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .approvers-container h4 {
            width: 100%;
            margin-top: 0;
            margin-bottom: 0;
            color: var(--purple-color);
            font-weight: 700;
        }
        .approver-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            min-width: 280px;
        }
        .approver-group label {
            font-weight: 500;
            white-space: nowrap;
            color: var(--secondary-color);
        }
        .approver-group input {
            width: 100%;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            border-radius: var(--border-radius);
            font-family: 'Vazirmatn', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .approver-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15);
        }

        .actions-container { margin: 30px 0 0; display: flex; flex-wrap: wrap; gap: 15px; }
        .action-btn { color: white; border: none; padding: 12px 25px; font-size: 16px; cursor: pointer; border-radius: var(--border-radius); font-family: 'Vazirmatn', sans-serif; font-weight: 500; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; flex-grow: 1; }
        .action-btn:disabled { background-color: var(--secondary-color); cursor: wait; opacity: 0.7; }
        .action-btn:active:not(:disabled) { transform: scale(0.98); }
        .add-row-btn { display: none; background-color: var(--success-color); }
        .export-btn { background-color: var(--primary-color); }
        .export-img-btn { background-color: var(--info-color); color: var(--dark-color); }
        .finalize-btn { background-color: var(--purple-color); }
        .add-row-btn:hover:not(:disabled) { background-color: #157347; }
        .export-btn:hover:not(:disabled) { background-color: #004494; }
        .export-img-btn:hover:not(:disabled) { background-color: #0895b0; }
        .finalize-btn:hover:not(:disabled) { background-color: #5a379a; }
        
        .actions-container .finalize-btn {
            flex-basis: 100%;
        }

        #mobile-form-wrapper { display: block; }
        .mobile-form-container { border: none; border-radius: var(--border-radius); padding: 20px; background-color: var(--form-bg-color); display: flex; flex-direction: column; gap: 15px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .mobile-form-container h3 { text-align: center; margin-top: 0; margin-bottom: 10px; color: var(--primary-color); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .mobile-form-group { display: flex; flex-direction: row; align-items: center; gap: 10px; }
        .mobile-form-group label { font-weight: 500; font-size: 14px; color: var(--secondary-color); flex-basis: 85px; flex-shrink: 0; }
        .mobile-form-group > input, .mobile-form-group > select, .mobile-form-group .counter-input-group { border: 1px solid var(--border-color); border-radius: var(--border-radius); height: 48px; transition: border-color 0.2s, box-shadow 0.2s; }
        .mobile-form-group > input, .mobile-form-group > select { width: 100%; padding: 12px; font-size: 14px; box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; flex-grow: 1; }
        .required-field-error { border-color: var(--danger-color) !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25); }
        .required-field-error .choices__inner { border-color: var(--danger-color) !important; }
        #mobile-add-btn { background-color: var(--success-color); width: 100%; }
        #mobile-add-btn:hover { background-color: #157347; }
        .mobile-form-group .counter-input-group { flex-grow: 1; display: grid; grid-template-columns: 44px 1fr 44px; align-items: stretch; overflow: hidden; background-color: #fff; }
        .counter-input-group input[type="number"] { grid-column: 2; border: none; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); background-color: transparent; text-align: center; font-weight: 700; font-size: 16px; padding: 0 5px; -moz-appearance: textfield; min-width: 0; }
        .counter-input-group input::-webkit-outer-spin-button, .counter-input-group input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .counter-btn { border: none; background-color: transparent; color: var(--primary-color); font-size: 24px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
        .counter-btn.plus-btn { grid-column: 1; }
        .counter-btn.minus-btn { grid-column: 3; }
        .counter-btn:hover:not(:disabled) { background-color: #eaf2ff; }
        .counter-btn:active:not(:disabled) { background-color: #d1e7dd; color: var(--success-color); }
        .accordion-header { background-color: var(--light-color); border: 1px solid var(--border-color); padding: 12px 15px; cursor: pointer; border-radius: var(--border-radius); font-weight: 700; margin-top: 10px; position: relative; transition: background-color 0.2s; display: flex; align-items: center; }
        .accordion-header:hover { background-color: #e2e6ea; }
        .accordion-header i { position: absolute; left: 15px; font-size: 16px; transition: transform 0.3s ease; }
        .accordion-header.active i { transform: rotate(180deg); }
        .accordion-content { display: none; padding: 15px; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 var(--border-radius) var(--border-radius); flex-direction: column; gap: 15px; background-color: #fff; }
        #mobile-summary-list { list-style-type: none; padding: 0; margin-top: 25px; }
        #mobile-summary-list li { background-color: #fff; border: 1px solid var(--border-color); border-right: 5px solid var(--info-color); padding: 12px 15px; margin-bottom: 10px; border-radius: var(--border-radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px; transition: all 0.2s ease-out; }
        #mobile-summary-list li.deleting {
            background-color: var(--danger-color) !important;
            color: white;
            transform: scale(0.95);
        }
        #mobile-summary-list li.deleting .summary-text, #mobile-summary-list li.deleting .summary-details, #mobile-summary-list li.deleting .summary-details span {
            color: white !important;
        }
        .summary-main-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .summary-text { font-size: 14px; font-weight: 700; color: var(--primary-color); }
        .summary-count { font-weight: 700; font-size: 14px; color: var(--danger-color); background-color: #f8d7da; padding: 3px 8px; border-radius: 12px; }
        .summary-details { font-size: 11px; color: var(--secondary-color); display: flex; flex-wrap: wrap; gap: 4px 12px; width: 100%; border-top: 1px dashed var(--border-color); padding-top: 8px; }
        .summary-details span { display: flex; align-items: center; gap: 4px; }
        .summary-details i { font-size: 12px; }
        #desktop-legends-wrapper .legends { margin-top: 30px; padding: 20px; border: 1px dashed var(--border-color); border-radius: var(--border-radius); background-color: var(--light-color); }
        #mobile-legends-wrapper .legends { margin-top: 5px; border: none; padding: 0; }
        
        /* START: Style Changes for Legends Grid */
        .compact-legend-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .compact-legend-list li {
            height: 55px;
            padding: 5px;
            cursor: pointer;
            border-radius: 6px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            font-size: 11px;
            user-select: none;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* END: Style Changes for Legends Grid */

        .form-locked .compact-legend-list li { cursor: not-allowed; }
        
        @media (min-width: 992px) {
            .compact-legend-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: flex-start;
            }
            .compact-legend-list li {
                height: auto;
                padding: 6px 14px;
                border-radius: 20px;
                font-size: 12px;
                display: inline-block;
            }
        }

        .compact-legend-list li:hover:not(.form-locked *) { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .compact-legend-list li:active:not(.form-locked *) { transform: scale(0.95); }
        .icon-supplier { color: var(--supplier-icon-color); }
        .icon-source { color: var(--source-icon-color); }
        .icon-defect { color: var(--defect-icon-color); }
        
        @media (min-width: 992px) {
            body { padding: 15px; }
            .container { padding: 35px; box-shadow: var(--shadow); border-radius: var(--border-radius); }
            header, .top-controls { flex-wrap: nowrap; }
            .header-center { order: 0; flex-basis: auto; justify-content: initial; }
            .header-center h1 { font-size: 26px; }
            .header-center i { font-size: 32px; }
            .header-right div { font-size: 16px; }
            .top-controls { flex-direction: row; justify-content: space-between; align-items: center; border: none; background-color: transparent; padding: 0; }
            .form-meta { width: auto; }
            .table-wrapper { display: block; }
            #mobile-form-wrapper { display: none; }
            .actions-container { justify-content: flex-start; }
            .action-btn { flex-grow: 0; }
            .add-row-btn { display: inline-flex; }
            .actions-container .finalize-btn {
                flex-basis: auto;
            }
        }
        
        /* --- STYLES FOR LIST-STYLE IMAGE CAPTURE --- */
        .image-capture-mode-list-style {
            width: 900px;
            background-color: #ffffff;
            padding: 35px;
            box-shadow: none;
            position: absolute;
            left: -9999px;
            top: 0;
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl;
            color: var(--dark-color);
        }
        .image-capture-mode-list-style header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .image-capture-mode-list-style .header-center { display: flex; align-items: center; gap: 10px; }
        .image-capture-mode-list-style .header-center h1 { margin: 0; font-size: 22px; font-weight: 700; color: var(--primary-color); }
        .image-capture-mode-list-style .header-center i { font-size: 28px; color: var(--primary-color); }
        .image-capture-mode-list-style .header-left div { font-size: 12px; color: var(--secondary-color); }
        .image-capture-mode-list-style .header-right div { font-size: 14px; font-weight: 700; color: var(--secondary-color); }
        .export-top-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            font-size: 14px;
        }
        .export-top-info div { color: var(--secondary-color); }
        .export-top-info div strong { color: var(--dark-color); }
        .export-items-list { display: flex; flex-direction: column; gap: 15px; }
        .export-item-card {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-right: 5px solid var(--info-color);
            border-radius: var(--border-radius);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .export-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .export-item-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        .export-item-count {
            font-weight: 700;
            font-size: 14px;
            color: var(--danger-color);
            background-color: #f8d7da;
            padding: 4px 12px;
            border-radius: 16px;
            white-space: nowrap;
        }
        .export-item-details {
            font-size: 13px;
            color: var(--secondary-color);
            display: flex;
            flex-wrap: wrap;
            gap: 8px 18px;
            width: 100%;
            border-top: 1px dashed var(--border-color);
            padding-top: 12px;
        }
        .export-item-details span { display: flex; align-items: center; gap: 6px; }
        .export-item-details i {
            font-size: 14px;
        }
        .export-item-details span i.bi-chat-left-text {
            color: var(--secondary-color);
        }
        
        .image-capture-mode-list-style .approvers-container {
            display: flex; 
            flex-wrap: nowrap; 
            gap: 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-top: 25px;
            overflow: hidden;
        }
        .image-capture-mode-list-style .approvers-container > h4 {
            display: none;
        }
        .image-capture-mode-list-style .approver-group {
            flex: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            border-left: 1px solid var(--border-color);
        }
        .image-capture-mode-list-style .approver-group:last-child {
            border-left: none;
        }
        .image-capture-mode-list-style .approver-group label {
            font-weight: 700;
            color: var(--dark-color);
            font-size: 13px;
            margin-bottom: 5px;
        }
        .image-capture-mode-list-style .approver-group-name {
            font-weight: 500;
            color: var(--primary-color);
            font-size: 15px;
            min-height: 24px;
        }
    </style>
</head>
<body>

<!-- محتوای بادی و تگ‌های اسکریپت بدون تغییر در اینجا قرار می‌گیرند -->
<!-- ... -->

<div class="container" id="main-container">
    <div id="exportable-area">
        <header>
            <div class="header-left"><div>کد مدرک : P1-QC-F-001/001</div></div>
            <div class="header-center"><i class="bi bi-clipboard2-data-fill"></i><h1>فرم هوشمند گزارش ضایعات</h1></div>
            <div class="header-right"><div>Pakshoma</div></div>
        </header>

        <div class="top-controls">
            <div class="form-meta"><label for="jalali_date">تاریخ :</label><input type="text" id="jalali_date" name="date" autocomplete="off"></div>
            <div class="form-meta"><label for="line">خط :</label><select id="line" name="line"><option>خط 1</option><option>خط 2</option><option>خط 3</option><option>خط 4</option><option>خط 5</option><option>خط 6</option><option>خط سبد</option><option>دیگ و درام</option><option>رنگ</option><option>سینک</option><option>کابین</option><option>مزونینگ</option><option>انبار در جریان</option><option>آزمایشگاه</option><option>پاکشوما2</option><option>پرسکاری</option><option>پنل</option><option>چاپ</option><option>چاپ پاکشوما2</option><option>خدمات</option></select></div>
            <div class="form-meta"><label for="product_type">نوع محصول :</label><select id="product_type" name="product_type"><option value="اتوماتیک" selected>اتوماتیک</option><option value="دوقلو">دوقلو</option><option value="ظرفشویی">ظرفشویی</option><option value="دربالا">دربالا</option><option value="جاروبرقی">جاروبرقی</option></select></div>
            <div class="form-meta waste-type-selector"><label><input type="radio" name="waste_type" value="برقی"> ضایعات برقی</label><label><input type="radio" name="waste_type" value="غیربرقی" checked> ضایعات غیربرقی</label></div>
        </div>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">ردیف</th>
                        <th rowspan="2">مدل محصول</th>
                        <th rowspan="2">گروه</th>
                        <th rowspan="2">آیتم</th>
                        <th rowspan="2">نام قطعه</th>
                        <th rowspan="2">تعداد کل</th>
                        <th colspan="4">تامین کننده</th>
                        <th colspan="3">منشا ضایعات</th>
                        <th rowspan="2" class="defects-summary-col">شرح ضایعات</th>
                        <th rowspan="2">توضیحات</th>
                        <th rowspan="2">عملیات</th>
                    </tr>
                    <tr>
                        <th data-target-name="supplier_injection">تزریق</th>
                        <th data-target-name="supplier_press">پرسکاری</th>
                        <th data-target-name="supplier_internal">داخلی</th>
                        <th data-target-name="supplier_external">خارجی</th>
                        <th data-target-name="source_packaging">بسته بندی</th>
                        <th data-target-name="source_warehouse">انبار</th>
                        <th data-target-name="source_production">حین تولید</th>
                    </tr>
                </thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </div>
    </div> 
    
    <div id="mobile-form-wrapper">
        <div class="mobile-form-container">
            <h3><i class="bi bi-plus-circle-dotted"></i> ثبت قطعه جدید</h3>
            <div class="accordion-header active">اطلاعات قطعه <i class="bi bi-chevron-down"></i></div>
            <div class="accordion-content" style="display: flex;">
                <div class="mobile-form-group"><label for="mobile-part-name">نام قطعه:</label><select id="mobile-part-name" data-required-name="نام قطعه"></select></div>
                <div class="mobile-form-group"><label for="mobile-total-count">تعداد کل:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-total-count">+</button><input type="number" id="mobile-total-count" value="1" min="1" data-required-name="تعداد کل"><button type="button" class="counter-btn minus-btn" data-target="mobile-total-count">−</button></div></div>
                <div class="mobile-form-group"><label for="mobile-product-model">مدل محصول:</label><input type="text" id="mobile-product-model" data-required-name="مدل محصول"></div>
                <div class="mobile-form-group"><label for="mobile-group">گروه:</label><select id="mobile-group" data-required-name="گروه"><option value="BVC">BVC</option><option value="CSC">CSC</option><option value="CSC-TL">CSC-TL</option><option value="DW-CSC">DW-CSC</option><option value="DW-TC">DW-TC</option><option value="KB">KB</option><option value="KVC">KVC</option><option value="TLX">TLX</option><option value="TT">TT</option><option value="VC">VC</option><option value="WM-KEN">WM-KEN</option><option value="سایر">سایر</option></select></div>
                <div class="mobile-form-group"><label for="mobile-item">آیتم:</label><input type="number" id="mobile-item" data-required-name="آیتم"></div>
            </div>
            <div class="accordion-header">جزئیات تامین کننده <i class="bi bi-chevron-down"></i></div>
            <div class="accordion-content"><div class="mobile-form-group"><label for="mobile-supplier-injection">تزریق:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-supplier-injection">+</button><input type="number" id="mobile-supplier-injection" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-supplier-injection">−</button></div></div><div class="mobile-form-group"><label for="mobile-supplier-press">پرسکاری:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-supplier-press">+</button><input type="number" id="mobile-supplier-press" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-supplier-press">−</button></div></div><div class="mobile-form-group"><label for="mobile-supplier-internal">داخلی:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-supplier-internal">+</button><input type="number" id="mobile-supplier-internal" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-supplier-internal">−</button></div></div><div class="mobile-form-group"><label for="mobile-supplier-external">خارجی:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-supplier-external">+</button><input type="number" id="mobile-supplier-external" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-supplier-external">−</button></div></div></div>
            <div class="accordion-header">منشا ضایعات <i class="bi bi-chevron-down"></i></div>
            <div class="accordion-content"><div class="mobile-form-group"><label for="mobile-source-packaging">بسته بندی:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-source-packaging">+</button><input type="number" id="mobile-source-packaging" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-source-packaging">−</button></div></div><div class="mobile-form-group"><label for="mobile-source-warehouse">انبار:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-source-warehouse">+</button><input type="number" id="mobile-source-warehouse" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-source-warehouse">−</button></div></div><div class="mobile-form-group"><label for="mobile-source-production">حین تولید:</label><div class="counter-input-group"><button type="button" class="counter-btn plus-btn" data-target="mobile-source-production">+</button><input type="number" id="mobile-source-production" value="0" min="0"><button type="button" class="counter-btn minus-btn" data-target="mobile-source-production">−</button></div></div></div>
            <div class="accordion-header">شرح نقص و توضیحات <i class="bi bi-chevron-down"></i></div>
            <div class="accordion-content">
                <div class="mobile-form-group"><label for="mobile-defects-summary">شرح ضایعات:</label><input type="text" id="mobile-defects-summary" readonly placeholder="با کلیک روی موارد پایین اضافه کنید" data-required-name="شرح ضایعات"></div>
                <div id="mobile-legends-wrapper"></div>
                <div class="mobile-form-group"><label for="mobile-comments">توضیحات:</label><input type="text" id="mobile-comments"></div>
            </div>
            <button id="mobile-add-btn" class="action-btn"><i class="bi bi-check-circle-fill"></i> ثبت و افزودن به لیست</button>
        </div>
        <ul id="mobile-summary-list"></ul>
    </div>
    
    <div class="approvers-container">
        <h4><i class="bi bi-patch-check-fill"></i> تایید کنندگان نهایی</h4>
        <div class="approver-group">
            <label for="approver-control">1. نماینده کنترل:</label>
            <input type="text" id="approver-control">
        </div>
        <div class="approver-group">
            <label for="approver-line">2. نماینده تولید:</label>
            <input type="text" id="approver-line">
        </div>
        <div class="approver-group">
            <label for="approver-eng">3. نماینده فنی و مهندسی:</label>
            <input type="text" id="approver-eng">
        </div>
    </div>

    <div class="actions-container">
        <button class="action-btn add-row-btn" onclick="addRow()"><i class="bi bi-plus-lg"></i> افزودن ردیف</button>
        <button class="action-btn finalize-btn" onclick="finalizeForm()"><i class="bi bi-check2-circle"></i> ثبت نهایی فرم</button>
        <button class="action-btn export-btn" onclick="exportToCSV()"><i class="bi bi-file-earmark-spreadsheet-fill"></i> خروجی CSV</button>
        <button class="action-btn export-img-btn" onclick="exportToImage()"><i class="bi bi-camera-fill"></i> خروجی تصویر فرم</button>
    </div>

    <div id="desktop-legends-wrapper"></div>
</div>

<div class="legends" id="legends-container" style="display:none;">
    <h4>برای ثبت نقص روی موارد زیر کلیک کنید (کلیک راست یا لمس طولانی برای کاهش):</h4>
    <ul class="compact-legend-list" id="legends-list">
         <li data-defect-name="شکستگی">شکستگی</li><li data-defect-name="نقص تزریق">نقص تزریق</li><li data-defect-name="غری/دفرمگی/تابدار">غری/دفرمگی/تابدار</li><li data-defect-name="زدگی/خط و خش">زدگی/خط و خش</li><li data-defect-name="سوراخ/پارگی">سوراخ/پارگی</li><li data-defect-name="هرز شدن رزوه">هرز شدن رزوه</li><li data-defect-name="نقص چاپ">نقص چاپ</li><li data-defect-name="ابعادی">ابعادی</li><li data-defect-name="کسری">کسری</li><li data-defect-name="نقص رنگ">نقص رنگ</li><li data-defect-name="عدم عملکرد">عدم عملکرد</li><li data-defect-name="قطعی سیم و سوکت">قطعی سیم و سوکت</li><li data-defect-name="روشن نمی شود">روشن نمی شود</li><li data-defect-name="نقص صفحه نمایش">نقص صفحه نمایش</li><li data-defect-name="ارور">ارور</li><li data-defect-name="نویز/صدا">نویز/صدا</li><li data-defect-name="تست و راه اندازی">تست و راه اندازی</li><li data-defect-name="خطای اپراتور">خطای اپراتور</li><li data-defect-name="مشکل رول">مشکل رول</li><li data-defect-name="پانچ نادرست">پانچ نادرست</li><li data-defect-name="پرس ناقص">پرس ناقص</li><li data-defect-name="شکستگی جای پیچ وزنه">شکستگی جای پیچ وزنه</li><li data-defect-name="شکستگی حین جا به جایی">شکستگی حین جا به جایی</li><li data-defect-name="شکستگی پایه کمک/موتور">شکستگی پایه کمک/موتور</li><li data-defect-name="خرابی دوخت">خرابی دوخت</li><li data-defect-name="سایر">سایر</li>
    </ul>
</div>

<!-- فایل‌های JS محلی -->
<script src="assets/js/jdp.min.js"></script>
<script src="assets/js/choices.min.js"></script>

<script>
    // --- تمام کدهای جاوا اسکریپت شما بدون تغییر در اینجا قرار می‌گیرد ---
    // --- ...
    let tableBody, productTypeSelect, legendsContainer, activeRow, mobileForm, desktopLegendsWrapper, mobileLegendsWrapper;
    let defaultProductModel = '', defaultGroup = '', defaultItem = '';
    
    let mobilePartNameChoice;
    const desktopPartNameChoices = new Map();
    const choicesConfig = {
        searchPlaceholderValue: 'جستجو...',
        removeItemButton: false,
        itemSelectText: 'انتخاب',
        noResultsText: 'موردی یافت نشد',
        noChoicesText: 'گزینه‌ای برای انتخاب وجود ندارد',
        shouldSort: false,
    };

    const allPartLists = { 'اتوماتیک': ["اسفنج نواری زیر سقف", "المنت", "انتقال دهنده نور (هدایتگر نور)", "اورینگ دور دیگ", "باگلت ولوم", "بالانسر", "براکت لولای درب", "برد", "برگه راهنمای محصول", "بست اشکی", "بست پشت لاستیک دور درب", "بست پیچ خور شیلنگ جاپودری به دیگ (پایین)", "بست جلو لاستیک دور درب", "بست سیمی", "بست شیلنگ جا پودری (پایین) (پیچ خور)", "بست شیلنگ جاپودری (بالا)", "بست شیلنگ دیگ به پمپ (بالا) (پیچ خور)", "بست شیلنگ دیگ به پمپ (پایین)", "بست شیلنگ شیر برقی", "بست شیلنگ هیدروستات", "بست فلزی شیلنگ خروجی", "بست کمری", "بست کمری خاری (بلند)", "بست کمری خاری (کوتاه)", "بست محفظه هیدروستات به شیلنگ دیگ به پمپ", "بلبرینگ", "بوش پایه موتور", "بوش پلاستیکی پیچ ترمز", "پایه کابین", "پایه ولوم", "پمپ تخلیه", "پوسته جلو کندی زیروات", "پوسته جلو مولد 1", "پوسته جلو مولد 2", "پوسته جلو مولد 3", "پوسته عقب کندی زیروات", "پوسته عقب مولد 1", "پوسته عقب مولد 2", "پوسته عقب مولد 3", "پیچ ارت", "پیچ بالانسر", "پیچ برد", "پیچ بست و کابل", "پیچ پمپ", "پیچ ترانس", "پیچ ترمز", "پیچ جاپودری", "پیچ خار المنت", "پیچ خارسینی", "پیچ دور درب", "پیچ سپری", "پیچ سقف", "پیچ سقف قرقره", "پیچ سنگ", "پیچ سینی پشت", "پیچ سینی جلو و صلیبی", "پیچ شیربرقی", "پیچ فولی", "پیچ قاب فیلتر", "پیچ لولای درب", "پیچ موتور", "پیچ میکروسوئیچ", "پیچ واشر دار دور دیگ", "ترانس", "پین کمک فنر", "تسمه بسته بندی", "تسمه موتور", "تسمه میکروسوئیچ درب", "جاپودری", "جای مایع نرم کننده (لاجوردی)", "خار المنت", "خار سینی جلو", "خار شیلنگ هیدروستات (نگهدارنده)", "خار فنر دیگ", "در پوش پیچ ترمز", "درب قاب فیلتر", "درب کشویی", "درپوش شیلنگ تخلیه پمپ (اضطراری)", "دسته سیم اصلی", "دکمه های سیلیکونی", "رول ورق", "زبانه درب شیشه", "زه جلوی سقف", "زه عقب سقف", "سقف چوبی (نئوپان سقف)", "سنگ بالا", "سنگ جلو چپ", "سنگ جلو راست", "سوزن منگنه کارتن", "سینی پشت", "سینی پشت آبکش", "سینی جلو", "سینی جلو C", "سینی جلو آبکش", "سینی جلو روغنی سفید", "شیر برقی دوقلو (سرد)", "شیربرقی تک (گرم)", "شیشه درب", "شیلنگ آب ورودی (سرد)", "شیلنگ آب ورودی (گرم)", "شیلنگ جاپودری به دیگ(دوراهی)", "شیلنگ خروجی", "شیلنگ دیگ به پمپ (سه راهی)", "شیلنگ شیر برقی", "شیلنگ هیدروستات", "صداگیر کابین", "صلیبی بالا (چپ)", "صلیبی بالا (راست)", "صلیبی فیلتر", "صلیبی کف (چپ)", "صلیبی کف (راست)", "صلیبی کنترل پنل", "ضربگیر شیلنگ هیدروستات", "ضمانت نامه", "طلق درب (طلق دودی)", "طلق درب کشویی", "طلق نمایشگر کنترل پنل", "عصایی", "فنر دیگ", "فولی", "قاب بالای جا پودری", "قاب بیرونی درب (کروم)", "قاب بیرونی ولوم (درپوش ولوم)", "قاب پایین جا پودری", "قاب درونی درب", "قاب فیلتر", "قاب کنترل پنل", "قاب میانی جا پودری", "کابل برق", "کابین", "کارت QR کد", "کارتن بسته بندی محصول", "کاسه نمد", "کاور بسته بندی شیلنگ زیرووات(30*40)", "کاور بسته بندی محصول", "کاور ضمانت نامه", "کاور کف", "کشویی", "کلید ON /OFF-START/PAUSE", "کلید کنترل پنل", "کمک فنر", "گردگیر پیچ ترمز", "لاستیک دور درب", "لوگوی برند محصول", "لولای درب شیشه", "لیبل ارت", "لیبل انرژی", "لیبل تبلیغاتی 144 ماه وارانتی", "لیبل تبلیغاتی12 سال وارنتی", "لیبل دو دقیقه انگلیسی", "لیبل ظرفیت محصول (8kg)", "لیبل قیمت", "لیبل کنترل نهایی", "لیبل متالیک", "لیبل محافظ المنت", "لیبل مدل روی کارتن", "لیبل مصرف آب", "مجموعه آبکش", "مجموعه پیچ ترمز", "مجموعه پیچ سنگ (با واشر)", "مجموعه پیچ موتور (با واشر)", "مجموعه جاپودری(با کشویی)", "مجموعه درب", "مجموعه سپری", "مجموعه سقف", "مجموعه شیلنگ جاپودری به دیگ", "مجموعه شیلنگ خروجی ضربه گیر و بست", "مجموعه شیلنگ دیگ به پمپ", "مجموعه کشویی", "مجموعه کنترل پنل", "مجموعه ولوم کروم", "محافظ ابری شیلنگ خروجی", "محافظ شیلنگ خروجی", "محافظ کابل", "محفظه هیدروستات", "موتور", "مهره پیچ موتور", "میکروسوئیچ درب", "نگهدارنده شیلنگ خروجی", "نگهدارنده شیلنگ و کابل", "نویزگیر", "واشر پیچ سنگ بالا , واشر پیچ سنگ جلو", "واشر پیچ فولی", "واشر پیچ موتور", "واشر تخت پیچ ترمز", "واشر زیر سنگ", "ورق استیل", "ورق آبکش", "ورق کابین", "هوزینگ بلبرینگ", "هیدروستات", "یونولیت ستون", "یونولیت سقف", "یونولیت کف"], 'دوقلو': ["اورینگ تقسیم آب", "اهرم سیم ترمز درب", "اهرم هدایت کننده تقسیم آب", "ایرجت", "آبشاری", "آبکش", "باگلت تایمر", "باگلت تخلیه", "براکت موتور خشک کن", "بست کمری ساده", "بوش پروانه شستشو", "بوش حباب ساز", "بوش کوپلینگ", "پایه کلید تیغه ای (پایه پلاتین)", "پایه لاستیک والف", "پایه لولای فریم چپ", "پایه لولای فریم راست", "پایه میکروسوئیچ", "پایه نگهدارنده لگن", "پایه ولوم سه خاره", "پرزگیر", "پروانه خنک کننده", "پروانه شستشو", "پشت آبشاری", "پمپ تخلیه", "پوسته سیفون", "پیچ ارت", "پیچ اهرم تقسیم آب", "پیچ براکت به کمک فنر", "پیچ پایه میکروسوییچ به پنل", "پیچ پروانه شستشو", "پیچ پلاتین به پایه", "پیچ پمپ به کفی", "پیچ پنل به فریم", "پیچ تایمر", "پیچ تقسیم آب به پنل", "پیچ جلو پنل به فریم", "پیچ حباب ساز پروانه", "پیچ دستگیره", "پیچ رابط ورودی آب", "پیچ زه آبکش", "پیچ سینی پشت", "پیچ صفحه ترمز", "پیچ فریم به کابین", "پیچ فریم به کابین + دستگیره", "پیچ فریم به لگن", "پیچ فولی به موتور شستشو", "پیچ کفی آبشاری", "پیچ کفی به کابین", "پیچ کفی به لگن", "پیچ کمک فنر به کفی", "پیچ کوپلینگ به آبکش", "پیچ کوپلینگ به موتور خشک کن", "پیچ گیربکس به لگن", "پیچ لگن به کابین", "پیچ مغزی تقسیم آب", "پیچ موتور خشک کن به کمک فنر", "پیچ موتور خشکن به براکت", "پیچ موتور شستشو به کfi", "پیچ مهره کاسه نمدی پیچ شفت آبکش", "پیچ مهره واشر سرخود پیچ موتور شستشو", "پیچ میکروسوییچ به پایه", "پیچ میکروسوییچ به طلق پنل", "پیچ واشر تخت زیر پروانه", "پیچ واشر خورشیدی پیچ موتور شستشو", "پیچ واشر فنری زیر پیچ گیربکس", "پین سیفون", "تایمر برنامه", "تایمر خشک کن", "تایمر شستشو", "تسمه بسته بندی", "تسمه تخلیه", "تسمه ترمز درب (سیم ترمز درب خ)", "تسمه موتور", "تسمه ولوم", "چسب دوطرفه", "حباب ساز", "خار نگهدارنده موتور خشک کن", "خازن اصلی", "خازن کمکی 2MF", "درب خشک کن", "درب شستشو", "درب طلقی کنترل پنل", "درب کاور خشک کن", "درپوش پیچ پروانه شستشو", "درپوش پیچ فریم", "درپوش سیفون", "درجه تنظیم آب (قاب پرزگیر)", "دریچه والف", "دستگیره پرزگیر", "دفترچه راهنما", "دکمه اهرم تقسیم آب", "دکمه مغزی تقسیم آب", "دمپر درب خشک کن", "دمپر درب شستشو", "دو راهی تقسیم آب", "دو راهی تقسیم آب", "رابط سیفون (چپقی)", "رابط ورودی آب", "رابط ورودی بالای لگن خشکن", "رابط ورودی بالای لگن شستشو", "رینگ بزرگ ایرجت", "رینگ کوچک ایرجت", "زه آبکش", "زه درب خشک کن", "زه درب شستشو", "سوزن منگنه کارتن", "سیم 120سانتی زرد", "سیم 120سانتی سفید", "سیم 120سانتی مشکی", "سیم ارت کوتاه", "سیم بست", "سیم ترمز موتور خشک کن", "سینی پشت", "شفت آبکش", "شیشه درب خشک کن", "شیشه درب شستشو", "شیلنگ اطمینان", "شیلنگ تقسیم آب خشک کن", "شیلنگ تقسیم آب شستشو", "شیلنگ خروجی", "شیلنگ رابط پمپ به سیفون", "شیلنگ رابط لگن به سیفون", "شیلنگ ورودی آب", "صفحه ترمز", "ضربه گیر لاستیکی موتور شستشو", "ضمانت نامه", "طلق روی ایرجت", "عایق حرارتی سیم کشی (وارنیش)", "عصایی", "فریم", "فریم باگلت", "فنر درب خشک کن", "فنر درب شستشو", "فنر سیفون", "قاب درب خشک کن", "قاب درب شستشو", "قاب روی پیشانی", "کابل برق", "کابین", "کارت QR", "کارتن", "کاسه نمد", "کاور", "کاور پاکتی", "کاور ضمانت", "کاور کف", "کاور نایلونی سوراخ دار (بسته بندی)", "کفی", "کلید تیغه ای (پلاتین)", "کنترل پنل", "کوپلینگ", "کور کن سیم", "کورکن سیفون", "لاستیک سیفون", "لاستیک ضربه گیر درب شیشه ای", "لگن", "لیبل ارت", "لیبل تبلیغاتی", "لیبل روی کارتن بزرگ", "لیبل روی کارتن کوچک", "لیبل کنترل نهایی سه تیکه (1.2.3)", "لیبل متالیک", "مجموعه پرزگیر", "مجموعه تقیسم آب کامل(مغزی،اهرم、دکمه、واشر、اورینگ)", "مجموعه صفحه ترمز", "مجموعه کمک فنر", "مجموعه گیربکس", "محافظ شیلنگ خروجی", "محافظ لباس", "مغزی تقسیم آب", "موتور خشک کن", "موتور شستشو", "مهره واشر سرخود M6", "میکروسوئیچ", "واشر پلاستیکی پیچ موتور شستشو", "واشر تخت شفت گیربکس", "واشر تقسیم آب", "واشر خورشیدی", "واشر زیر پروانه شستشو", "واشر فنری", "یونولیت سقف", "یونولیت کف"], 'ظرفشویی': ["اسپری (اسپری بالا)", "اسپری پایین", "استپ ریل سبد بالا", "استپ ریل سبد قاشق و چنگال", "المنت", "اورینگ تقسیم آب", "اورینگ سبد بالا", "اورینگ مخزن نمک", "اورینگ مهره محفظه فشار شکن", "اورینگ هوزینگ", "برچسب تبلیغاتی 12YEARS", "برچسب کنترل نهایی سه تیکه", "برچسب متالیک", "برد پنل", "برد کف (برد اصلی)", "بست 175", "بست 286", "بست 46", "بست شلنگ خروجی محفظه نمک", "بست شیلنگ هیدروستات", "بست فلزی شیلنگ ورودی پمپ به هوزینگ", "بست کابل برق", "بست کمری", "بست محافظ شیلنگ خروجی", "پایه اسپری پایین", "پایه استیل بزرگ", "پایه استیل کوچک", "پایه چرخ ریل", "پایه کابین", "پایه لولا چپ", "پایه لola راست", "پلیت تنظیم فنر درب", "پمپ پمپاژ (موتور)", "پمپ تخلیه", "پیچ (                      ) 16 * M4", "پیچ (                      ) M2.9*6.5(+)", "پیچ (                      ) M3.5*10", "پیچ (                      ) M3.5*9", "پیچ (                      ) M3.9*13", "پیچ (                      ) M3.9*14", "پیچ (                      ) M3.9*16", "پیچ (                      ) M3.9*25", "پیچ (                      ) M4*10(*)", "پیچ (                      ) M4*30", "پیچ (                      ) M4.2*9.5(*)", "پیچ (                      ) M5*8", "پیچ (                      ) M5*8(+)", "پیچ (                      ) ST3.9*13 (+)", "پیچ (                      ) ST3.9*16 (+)", "پیچ (                      ) فنر تنظیم درب", "پیچ (                      ) نمره 16 * 4", "پیچ (                      ) نمره 8 * M4", "پین پایه لولا", "پین چرخ سبد بالا", "پین چرخ کفی", "ترموستات", "تسمه بسته بندی", "تسمه نخی درب", "تقسیم آب", "توپی تقسیم آب", "جاپودری (دیس پنسر)", "چرخ سبد بالا", "چرخ سبد پایین", "چرخ سبد قاشق چنگال بالا", "چرخ کفی", "خار قلاب تسمه درب", "در پوش طوسی کابین", "درب استیل (سینی جلو استیل)", "درب قاب برد کف", "درب مخزن نمک", "درپوش هوزینگ", "دسته سیم اصلی", "دسته سیم کمکی (رابط برد به پنل) (کابل دیتا)", "رابط اسپری", "ریل سبد چپ بالا", "ریل سبد چپ پایین", "ریل سبد راست بالا", "ریل سبد راست پایین", "زبانه درب", "زه استیل دور سینک", "زه سقف جانبی", "زه سقف جلو", "زه سقف عقب", "سبد بالا", "سبد پایین", "سبد قاشق چنگال بالا", "سقف چوبی", "sensor", "سوزن منگنه کارتن", "سیم بست", "سیم رابط پنل به برد کف", "سینک", "سینی بغل چپ", "سینی بغل راست", "سینی جلو روغنی", "سینی سقف سینک", "سینی کف سینک", "شیربرقی", "شیلنگ پمپ تخلیه به محفظه فشار شکن", "شیلنگ خروجی", "شیلنگ خروجی محفظه نمک", "شیلنگ شیربرقی", "شیلنگ هیدروستات", "شیلنگ ورودی آب", "صافی استیل کف", "صافی پلاستیکی کف", "صلیبی استیل جلو", "صلیبی سمت چپ(بغل)", "صلیبی سمت راست(بغل)", "صلیبی فلزی بالای درب (زبانه)", "صلیبی لولای درب", "ضمانت نامه", "طلق کنترل پنل", "عایق بغل", "عایق درب استیل", "عایق سقف", "عایق کف", "عصایی", "فنر درب", "فوم اسفنجی", "فوم اسفنجی لای سبد", "فوم پله دار", "فوم درب استیل", "فوم محافظ بسته بندی", "فیلتر بیرونی", "فیلتر داخلی", "قاب برد کف", "قاب زیر", "قاب شناور", "قیف مخصوص نمک", "کابل برق", "کارت QR", "کارتن پلاست پشت", "کارتن ظرفشویی", "کاور  نایلونی سوراخ دار", "کاور پایه لولای چپ (محافظ)", "کاور پایه لولای راست (محافظ)", "کاور دستگیره درب", "کاور زیر کفی", "کاور کف", "کفی", "کلید کنترل پنل", "کنترل پنل (قاب کنترل پنل)", "کورکن", "کورکن دهانه پمپ پمپاژ", "کورکن دهانه پمپ تخلیه", "کورکن کابل", "گسکت پایین درب", "گسکت تقسیم آب", "لاستیک آبندی دور درب", "لولای درب (چپ)", "لولای درب (راست)", "لوله L شکل بالایی", "لوله L شکل پایینی", "لوله میانی", "لیبل شماره سریال بدنه", "لیبل مدل", "مجموعه پوسته جلو پمپ پمپاژ", "مجموعه پوسته جلو و میکروسوئیچ", "مجموعه درب استیل", "مجموعه درب و پنل", "مجموعه سبد بالایی", "مجموعه سبد پایین", "مجموعه سقف", "مجموعه فشارشکن", "مجموعه کابین", "مجموعه کنترل پنل", "مجموعه لوله رابط اسپری داخل سینک", "مجموعه محفظه فشارشکن", "مجموعه محفظه نمک", "مجموعه موتور تقسیم آب", "مجموعه هوزینگ بدون sensor", "محافظ سینی چپ و راست", "محفظه نمک", "مهره محفظه فشار شکن", "مهره مخزن نمک", "میکروسوئیچ درب", "میکروسوئیچ شناور", "ناودانی", "نگهدارنده پشتی", "نگهدارنده پمپ پمپاژ", "نگهدارنده جاپودری", "نگهدارنده کورکن کابل", "نمد صداگیر سقف", "نمد صداگیر سینی جلو", "نیمه ی بالایی اسپری", "نیمه ی پایینی اسپری", "هوزینگ", "هیدروستات", "واشر بشقابی بزرگ", "واشر بشقابی کوچک", "واشر لاستیکی گرد", "والف هوزینگ", "ورق استیل", "ورق اصلی سینک", "ورق درب استیل", "ورق روغنی", "ورق سینی جلو", "ورق سینی سقف", "ورق سینی کف", "وزنه تعادل ظرفشویی", "یونولیت جلو", "یونولیت زیر سبد", "یونولیت سقف", "یونولیت شناور", "یونولیت کف", "یونولیت کناره", "یونولیت محافظ بسته بندی"],'جاروبرقی': ["اسفنج جعبه لوازم جانبی", "اسفنج دور موتور", "اسفنج صداگیر موتور", "اسفنج فیلتر خروجی", "اسفنج فیلتر ورودی هوا", "اسفنج ورودی هوا", "اهرم پدال سیم جمع کن", "اهرم ترمز سیم جمع کن", "اورینگ پایه مکش", "اورینگ جلوی موتور", "اورینگ درب فیلتر خروجی", "اورینگ دهانه مکش", "اورینگ دهانه مکش فریم", "اورینگ رابط بین محفظه موتور و مخزن زباله", "اورینگ زیر فریم جارو", "اورینگ فیلتر خروجی", "اورینگ قاب موتور", "اورینگ کفی", "اورینگ محفظه موتور", "بدنه سوپاپ اطمینان", "برچسب دستورالعمل تخلیه مخزن", "برچسب کنترل نهایی (سه تیکه)", "برچسب متالیک", "برچسب متالیک سایز60*140", "برد", "برس کف", "برس گردگیر", "برس مبلی", "پایه پلاتین", "پایه سیم جمع کن", "پایه کلید ON / OFF", "پایه مکش", "پایه موتور", "پایه نگهدارنده کیسه زباله", "پدال خاموش و روشن", "پدال سیم جمع کن", "پلاتین", "پیچ M4 * 12", "پیچ M4 * 16", "پیچ سر عدسی تمام رزوه فولادی 10*3.9", "پیچ سرعدسی تمام رزوه فولادی ST3 * 12", "پیچ سرعدسی تمام رزوه فولادی ST4 * 8", "پیچ سرعدسی واشر سرخود تمام رزوه فولادی 10 * 4", "پیچ سرعدسی واشر سرخود تمام رزوه فولادی 8 * 2.9", "پیچ16*4", "پیستون سوپاپ اطمینان", "پین ترمز سیم جمع کن", "پین چرخ", "پین درب کیسه زباله", "پین شفت", "پین فنر سیم جمع کن", "ترمز سیم جمع کن", "جعبه لوازم جانبی", "چرخ بزرگ", "چرخ بزرگ جارو", "چرخ بزرگ چپ", "چرخ بزرگ راست", "چرخ سیم جمع کن (چپ)", "چرخ سیم جمع کن (راست)", "چرخ سیم جمع کن چپ", "چرخ سیم جمع کن راست", "چرخ کوچک", "چرخ کوچک جارو", "چرخ متوسط", "چسب حرارتی 12 میلی متر", "خروجی سیم", "درب جعبه لوازم جانبی", "درب کیسه زباله", "درب مخزن زباله طوسی تیره خودرنگ", "درب مخزن زباله نقره ای", "درپوش سوپاپ اطمینان", "درپوش عقب", "دستگیره درب کیسه زباله", "دستگیره درب کیسه زباله سیلور خودرنگ", "دستگیره طوسی تیره خودرنگ", "دستگیره مخزن زباله طوسی تیره خودرنگ", "دستگیره مخزن زباله نقره ای", "دستگیره نقره ای", "دکمه درب جعبه لوازم جانبی(چپ)", "دکمه درب جعبه لوازم جانبی(راست)", "دهانه مکش", "رابط بین محفظه موتور و مخزن زباله", "رینگ برنزی بزرگ", "رینگ برنزی کوچک", "رینگ درب کیسه زباله", "رینگ درب کیسه زباله طوسی تیره خودرنگ", "رینگ درب مخزن زباله", "رینگ سوپاپ اطمینان", "رینگ مسی بزرگ", "رینگ مسی بزرگ سیم جمع کن", "رینگ مسی کوچک", "رینگ مسی کوچک سیم جمع کن", "زبانه قفل مخزن زباله", "زبانه کلید محفظه موتور", "زه بغل چپ طوسی تیره", "زه بغل راست طوسی تیره", "سوپاپ اطمینان", "سیم جمع کن", "سیم رابط برد به سیم جمع کن(قرمز)", "سیم رابط سیم جمع کن به کلید روشن خاموش", "سیم موتور به برد (آبی)", "شفت", "شیلنگ خرطومی", "شیلنگ لوله خرطومی", "صفحه فلزی سیم جمع کن", "ضربه گیر موتور", "ضمانت نامه غیر نصبی کنوود", "ضمانتنامه غیر نصبی A4 پاکشوما", "طلق روی درب فیلتر", "طلق روی درب فیلترطوسی تیره خود رنگ", "غلطک ترمز سیم جمع کن", "فرم اطلاعات تست محصول", "فریم جارو", "فریم میانی طوسی تیره", "فریم میانی طوسی تیره خودرنگ", "فنر اهرم پدال سیم جمع کن", "فنر اهرم ترمز", "فنر پدال خاموش روشن و سیم جمع کن", "فنر دستگیره درب و پایه نگهدارنده کیسه زباله", "فنر زبانه قفل مخزن زباله", "فنر زبانه کلید محفظه موتور", "فنر سوپاپ", "فنر سوپاپ اطمینان", "فنر سیم جمع کن", "فنر کلید پاور", "فنر کلید مخزن زباله", "فنر ولوم", "فیلتر اسفنجی مخزن", "فیلتر اسفنجی ورودی هوا", "فیلتر پلاستیکی مخزن", "فیلتر خروجی", "فیلتر خروجی هوا", "فیلتر هوا", "فیلتر ورودی هوا", "قاب اهرم ترمز", "قاب پایین دستگیره طوسی تیره خودرنگ", "قاب پایین دستگیره نقره ای", "قاب پشت", "قاب پشت سرمه ای", "قاب پشت موتور", "قاب جعبه لوازم جانبی", "قاب جلوی موتور", "قاب چرخ بزرگ چپ طوسی تیره خودرنگ", "قاب چرخ بزرگ چپ نقره ای", "قاب چرخ بزرگ راست طوسی تیره خودرنگ", "قاب چرخ بزرگ راست نقره ای", "قاب درب مخزن زباله", "قاب روی فیلتر خروجی", "قاب روی فیلتر خروجی طوسی تیره خودرنگ", "قاب روی موتور", "قاب فیلتر خروجی", "قاب محافظ فنر", "قاب مشبک روی فیلتر خروجی", "قاب میانی", "قاب نگهدارنده کابل", "قاب ورودی هوا", "قاب ولوم", "کابل برق 5.2 متری", "کابل برق مشکی (9M)", "کارت QR کد برند پاکشوما", "کارت QR کد برند کنوود", "کارتن بسته بندی 32 * 36 * 54", "کارتن جاروبرقی دوسلدورف", "کارتن جاروبرقی کنوود ( طوسی تیره )", "کارتن محافظ بزرگ", "کاور چرخ سیم جمع کن", "کاور سوپاپ اطمینان", "کاور فوم بسته بندی محصول 70 * 58", "کاور موتور", "کاور نایلون شیرینگ با عرض 75 سانتیمتر (ضخامت 70 میکرون)", "کفی", "کلید ON / OFF", "کلید مخزن زباله طوسی تیره خودرنگ", "کلید مخزن زباله نقره ای", "کیسه یکبار مصرف جاروبرقی", "لاستیک پشت موتور", "لاستیک جلو موتور", "لولای درب جعبه لوازم جانبی", "لوله تلسکوپی", "لیبل انرژی بزرگ", "لیبل انرژی بزرگ جاروبرقی KVC 3522", "لیبل انرژی بزرگ جاروبرقی PVC 5125", "لیبل انرژی کوچک", "لیبل انرژی کوچک جاروبرقی PVC 5125", "لیبل انرژی کوچک جاروبرقیKVC 3522", "مجموعه برد اصلی و تنظیم قدرت", "مجموعه چرخ بزرگ چپ", "مجموعه چرخ جارو", "مجموعه چرخ لاستیکی کوچک", "مجموعه چرخ متوسط", "مجموعه خرطومی", "مجموعه درب مخزن زباله طوسی tیره", "مجموعه دستگیره", "مجموعه دهانه مکش", "مجموعه سوپاپ اطمینان", "مجموعه سیم جمع کن", "مجموعه فریم لاستیکی جارو", "مجموعه فیلتر خروجی", "مجموعه فیلتر ورودی", "مجموعه فیلتر ورودی هوا", "مجموعه لاستیکی چرخ بزرگ چپ", "مجموعه لاستیکی چرخ بزرگ راست جاروبرقی", "مجموعه لاستیکی چرخ کوچک", "مجموعه مخزن", "محافظ سیم", "محافظ کابل", "مخزن زباله", "مخزن زباله طوسی تیره", "موتور", "نازل کناره بلند", "نازل گوشه گیر", "نشانگر کیسه زباله", "نگهدارنده سیم جمع کن", "نگهدارنده لوله تلسکوپی", "نگهدارنده موتور", "نمدی کف", "نوار چسب شیشه ای (عرض 5 سانتمیتری)", "نوار لاستیکی درب کیسه زباله (درزگیر)", "واشر تخت گالوانیزه نمره 18 ضخامت 1.5", "ورق آلومینیوم ولوم", "ولوم تنظیم قدرت", "ولوم تنظیم قدرت کروم", "ولوم تنظیم کننده قدرت", "یونولیت بالا", "یونولیت بسته بندی جلو", "یونولیت بسته بندی عقب", "یونولیت جلو", "یونولیت عقب"], 'دربالا':["استیکر پنل", "استیکر تبلیغاتی FULL AUTOMATIC WASHING MACHINE (درب از بالا 7 کیلویی)", "اسفنج ضربه گیر شیلنگ هیدروستات", "اورینگ  لاستیکی شیر برقی", "اورینگ پشت پایه پرزگیر", "اورینگ جاپودری", "آبشاری", "آبکش", "براکت جلو", "براکت عقب", "براکت گیربکس", "براکت نگهدارنده", "برچسب روی پیچ", "برد", "بست  فلزی  شیلنگ خروجی", "بست  فلزی شیلنگ دیگ به پمپ", "بست شیلنگ دیگ به پمپ", "بست شیلنگ هیدروستات", "بست فلزی شیلنگ هیدروستات ", "بست کمربندی", "بست کمری ساده", "بوش پروانه", "پایه کابین پلاستیکی", "پایه کابین لاستیکی", "پایه لاستیکی زیر کفی", "پایه موتور", "پایه موتور بالا", "پایه موتور پایین", "پایه نگهدارنده پرزگیر", "پرزگیر", "پروانه شستشو", "پمپ تخلیه", "پنل شیر برقی A", "پوسته سیفون", "پیچ M4*10 (پیچ ارت)", "پیچ M5.3*26 (پیچ گیربکس)", "پیچ M5.3*26 (پیچ محافظ گیربکس)", "پیچ M6*16 (پیچ پلیت فلزی آبکشیی)", "پیچ M6*16 (پیچ موتور تخلیه و مجموعه سیفون)", "پیچ ST 4.0 *12.0 (پیچ پایه پرزگیر - سینی کف وقاب دونی جاپودری)", "پیچ ST 4.2 * 28 (پیچ زه روی آبکش)", "پیچ ST 5.0 *16.0 (پیچ بالانسر)", "پیچ ST4*10 ( سینی پشت و خازنیی )", "پیچ ST4*14 (پیچ برد - شیربرقی - کفی به لگن - جاپودری به فریم - فریم بالا -  میکروسوئیچ - عدم بالانس)", "پیچ ST4*16 (پیچ پمپ تخلیه)", "پیچ ST5.5*21.0 ( پیچ صفحه فلزی و آبکش )", "پیچ ST6.5*25 (پیچ صفحه گیربکس)", "پیچ ST8*30 (پیچ موتوریی)", "پیچ پایه تنظیم", "پیچ تمام رزوه سرشش گوش استیل SS M5.5*23 (سپری آبکش درب از بالای 7 کیلویی)", "پیچ تمام رزوه سرشش گوش فولادی  M5.5*25 (براکت فلزی و براکت پلاستیکی درب از بالا 7 کیلویی)", "پیچ تمام رزوه سرشش گوش فولادی M6*12 (پمپ تخلیه درب از بالای 7 کیلویی)", "پیچ تمام رزوه سرعدسی استیل SS st4*18 (زه روی بالانسر ، لولای درب درب از بالای 7 کیلویی)", "پیچ تمام رزوه سرعدسی فولادی ST4*12 ( جاپودری ، پنل ، برد ، سینی پشت", "پیچ سرخزینه سرتخت چهارسو استیل SS ST6*26 (پروانه شستشو درب از بالا 7 کیلویی)", "پیچ سرعدسی تمام رزوه استیل SS ST4x16B (بالانسر رینگ درب از بالای 7 کیلویی)", "پیچ سرعدسی تمام رزوه فولادی ST4*16 (براکت فلزی ، خازن ، فریم ، شیربرقی ، میکروسوییچ ، قاب جاپودری ، پایه کابین ، کفی درب از بالا 7 کیلویی)", "پیچ سرعدسی تمام رزوه فولادی ST4*20 (سیفون درب از بالای 7 کیلویی)", "پیچ سرعدسی تمام رزوه گرد استیل SS ST4*10-12 (پایه آبشاری،پرزگیر、دستگیره درب、رابط شیلنگ اطمینان درب از بالای 7 کیلویی)", "پیچ مهره دار تمام رزوه سرشش گوش فولادی  M6*21 (پروانه خنک کننده درب از بالای 7 کیلویی)", "پیچ و مهره M6 * 21 (پیچ و مهره فولی)", "پیچ واشردار تمام رزوه سرشش گوش فولادی M8*16 (گیربکس درب از بالای 7 کیلویی)", "پیچ واشردار تمام رزوه سرشش گوش فولادی M8*33 (موتور درب از بالای 7 کیلویی)", "پیچ واشردار تمام رزوه گرد فولادی ST4*8 (سیم ارت درب از بالای 7 کیلویی)", "پین درب", "پین سیفون", "پین لولای درب", "تسمه موتور", "توری پرزگیر", "جاپودری", "چسب آب بندی", "خازن", "درب", "درب  عقب درب از بالای 7 کیلویی", "درب جلو  درب از بالای 7 کیلویی", "درپوش پروانه شستشو", "درپوش پیچ", "درپوش پیچ پروانه", "درپوش سیفون", "درپوش فریم", "درپوش گیربکس", "درپوش نگهدارنده شیلنگ اطمینان", "دستگیر A", "دستگیره کابین", "دسته سیم اصلی", "دیگ", "رنگ ED ، ضریب مصرف بر اساس گرم ", "رنگ پودری ", "رینگ تعادل بالا", "رینگ تعادل پایین", "زه A", "زه بالای دیگ", "سپری آبکش", "سیفون", "سیم ارت", "سینی پشت", "سینی کف", "شیر برقی گرم", "شیربرقی", "شیربرقی سرد", "شیلنگ اطمینان", "شیلنگ پمپ به سیفون ", "شیلنگ خروجی", "شیلنگ دیگ به پمپ", "شیلنگ شیربرقی", "شیلنگ هیدروستات", "شیلنگ هیدروستات ", "شیلنگ ورودی آب", "شیلنگ ورودی آب سرد", "شیلنگ ورودی آب گرم ", "صفحه کوپلینگ", "صلیبی بالا کابین ", "صلیبی پایین کابین", "ضربه گیر", "ضربه گیر شیلنگ دیگ به پمپ", "ضربه گیر کابین درب از باالا 12 کیلو  50 * 100 میلی متر", "ضربه گیر موتور", "طلق کنترل پنل", "عصایی", "فریم", "فریم A", "فریم پرزگیر", "فنر جلو چپ", "فنر جلو راست", "فنر جلو سفید", "فنر درب", "فنر درب A", "فنر سیفون", "فنر عقب", "فنر عقب آبی", "فولی", "فولی موتور", "قاب بالای رینگ تعادل", "قاب بیرونی بالانسر", "قاب پایین رینگ تعادل", "قاب جاپودری", "قاب روی اهرم ترمز", "کابل", "کابل برق", "کابین", "کارتن بسته بندی", "کارتن بسته بندی درب از بالای 7 کیلویی", "کاور بسته بندی", "کاور بسته بندی قطعات", "کاور زیپ دار به ابعاد 5*5 جهت پیچ کفی درب از بالای 102 کیلو", "کاور لباسشویی", "کاور یونولیت کف", "کد QR", "کشویی جاپودری", "کفی", "کفی آبکش", "کنترل پنل A", "کورکن", "کورکن بالانس رینگ", "کورکن دیگ", "کورکن سوراخ بالانسر", "کورکن سیم", "کورکن کابل", "کیسه سیم بندی", "گریس فنر دیگ ، ضریب مصرف بر اساس گرم ", "گریس گیربکس ، ضریب مصرف بر اساس گرم ", "گیربکس", "لاستیک سیفون", "لولای درب چپ", "لولای دربراست", "لیبل اخطار", "لیبل انرژی", "لیبل انرژی TLX 7001", "لیبل تبلیغاتی-ضمانتنامه", "لیبل سرد", "لیبل گرم", "مجموعه برد", "مجموعه جاپودری", "مجموعه گیربکس", "محافظ زیر کفی", "محافظ شیربرقی", "محافظ شیلنگ خروجی", "مگنت بوبین سیفون و سیم رابط", "مگنت بویین سیفون", "مهره پایه کابین", "موتور", "موتور شستشو", "میکروسوییچ عدم بالانس", "میکروسوئیچ درب", "میکروسوئیچ عدم بالانس", "نگهدارنده پرزگیر", "نگهدارنده جا مایع", "نگهدارنده درب چپ()", "نگهدارنده درب راست", "نگهدارنده شیلنگ اطمینان", "نگهدارنده شیلنگ خروجی", "نگهدارنده عصایی", "نمدی روی فنر", "هیدروستات", "واشر M38*8", "واشر Φ 11.5 * 22 * 1.5 (واشر زیر پروانه)", "واشر بالای موتور", "واشر پایین موتور", "واشر پروانه", "واشر پشت شیربرقی", "واشر پیچ پروانه", "واشر گیربکس", "ورق آبکش", "یونولیت بالا", "یونولیت بغل", "یونولیت داخل آبکش درب از بالای 7 کیلویی", "یونولیت داخل میانی", "یونولیت ستون درب از بالای 7 کیلویی", "یونولیت سقف درب از بالای 7 کیلویی", "یونولیت کف", "یونولیت کف درب از بالای 7 کیلویی"] };
    
    // --- GLOBAL FUNCTIONS ---
    
    function addRow(fromMobileData = null) {
        const newRow = tableBody.insertRow();
        newRow.innerHTML = createRowHTML(tableBody.rows.length);

        const newSelect = newRow.querySelector('[name="part_name"]');
        const newChoice = new Choices(newSelect, choicesConfig);
        desktopPartNameChoices.set(newRow, newChoice);

        newSelect.addEventListener('change', () => validateRowVisuals(newSelect.closest('tr')));
        updateAllPartNameDropdowns(); 

        if (fromMobileData) { 
            Object.keys(fromMobileData).forEach(key => {
                const input = newRow.querySelector(`[name="${key}"]`);
                if (input) {
                    if (key === 'part_name') {
                        newChoice.setChoiceByValue(fromMobileData[key]);
                    } else {
                        input.value = fromMobileData[key];
                    }
                }
            });
        } else { 
            if (defaultProductModel) {
                newRow.querySelector('[name="product_model"]').value = defaultProductModel;
                newRow.querySelector('[name="group"]').value = defaultGroup;
                newRow.querySelector('[name="item"]').value = defaultItem;
            }
        }
        updateRowNumbers();
        setActiveRow(newRow);
        validateRowVisuals(newRow);
    }

    function deleteRow(button) { 
        const rowToDelete = button.closest('tr'); 
        if (!rowToDelete) return; 

        if (desktopPartNameChoices.has(rowToDelete)) {
            desktopPartNameChoices.get(rowToDelete).destroy();
            desktopPartNameChoices.delete(rowToDelete);
        }
        
        if (tableBody.rows.length <= 1 && document.documentElement.clientWidth >= 992) { 
            alert("نمی‌توانید آخرین ردیف را در نمای دسکتاپ حذف کنید."); 
            return; 
        } 
        rowToDelete.remove(); 
        updateRowNumbers(); 
        updateMobileSummary(); 
        if (tableBody.rows.length === 0 && document.documentElement.clientWidth >= 992) { 
            addRow(); 
        } 
        else { 
            activeRow = tableBody.rows.length > 0 ? tableBody.rows[0] : null; 
            if(activeRow) setActiveRow(activeRow); 
        } 
    }

    function generateFileName() {
        const { globalDate, globalLine, globalProductType, wasteType } = getGlobalData();
        const datePart = globalDate.replace(/\//g, '.');
        const linePart = globalLine.replace(/\s/g, '_');
        const wasteTypePart = wasteType === 'برقی' ? 'برقی' : 'غیربرقی';
        return `گزارش ضایعات روزانه ${datePart} - ${linePart} - ${globalProductType} - ${wasteTypePart}`;
    }

    function exportToCSV() {
        if (!validateAllForms()) return;
        const fileName = generateFileName();
        const { globalDate, globalLine, globalProductType, wasteType } = getGlobalData();
        const headers = ["تاریخ", "خط", "نوع محصول", "نوع ضایعات", "ردیف", "مدل محصول", "گروه", "آیتم", "نام قطعه", "تعداد کل", "تامین کننده-تزریق", "تامین کننده-پرسکاری", "تامین کننده-داخلی", "تامین کننده-خارجی", "منشا-بسته بندی", "منشا-انبار", "منشا-حین تولید", "شرح ضایعات", "توضیحات", "تایید کننده کنترل", "تایید کننده خط", "تایید کننده فنی"];
        let csvContent = "\uFEFF" + headers.join(',') + '\r\n'; 
        
        const controlApprover = document.getElementById('approver-control').value.trim();
        const lineApprover = document.getElementById('approver-line').value.trim();
        const engApprover = document.getElementById('approver-eng').value.trim();

        tableBody.querySelectorAll('tr').forEach(row => { 
            if (!row.querySelector('[name="part_name"]').value) return; 
            const cleanCell = (cellData) => `"${(cellData || '').toString().replace(/"/g, '""')}"`; 
            let rowDataValues = [ globalDate, globalLine, globalProductType, wasteType, row.querySelector('.row-number').textContent, ...Array.from(row.querySelectorAll('input, select')).map(el => el.value) ];
            rowDataValues.pop();
            rowDataValues.push(controlApprover, lineApprover, engApprover);
            csvContent += rowDataValues.map(cleanCell).join(',') + '\r\n';
        }); 
        downloadFile(csvContent, `${fileName}.csv`, 'text/csv;charset=utf-8;');
    }
    
    async function exportToImage() {
        if (!validateAllForms()) return;
        const fileName = generateFileName();
        const exportButton = document.querySelector('.export-img-btn');
        toggleButtonLoading(exportButton, true, "در حال آماده سازی...");

        const exportContainer = document.createElement('div');
        exportContainer.className = 'image-capture-mode-list-style';
        document.body.appendChild(exportContainer);

        try {
            const { globalDate, globalLine, globalProductType, wasteType } = getGlobalData();
            const wasteTypeText = document.querySelector(`input[name="waste_type"][value="${wasteType}"]`).parentElement.textContent.trim();
            const originalHeader = document.querySelector('header');

            let contentHTML = `
                ${originalHeader.outerHTML}
                <div class="export-top-info">
                    <div><strong>تاریخ :</strong> ${globalDate}</div>
                    <div><strong>خط :</strong> ${globalLine}</div>
                    <div><strong>نوع محصول :</strong> ${globalProductType}</div>
                    <div><strong>نوع ضایعات :</strong> ${wasteTypeText}</div>
                </div>
                <div class="export-items-list">
            `;

            tableBody.querySelectorAll('tr').forEach((row, index) => {
                const partNameInput = row.querySelector('[name="part_name"]');
                if (!partNameInput || !partNameInput.value) return;
                const data = Object.fromEntries(Array.from(row.querySelectorAll('input, select')).map(el => [el.name, el.value]));
                let detailsFinalHTML = '';
                
                const supplierParts = [];
                if (data.supplier_injection > 0) supplierParts.push(`تزریق: ${data.supplier_injection}`);
                if (data.supplier_press > 0) supplierParts.push(`پرسکاری: ${data.supplier_press}`);
                if (data.supplier_internal > 0) supplierParts.push(`داخلی: ${data.supplier_internal}`);
                if (data.supplier_external > 0) supplierParts.push(`خارجی: ${data.supplier_external}`);
                if (supplierParts.length > 0) detailsFinalHTML += `<span><i class="bi bi-person-fill icon-supplier"></i> ${supplierParts.join(' | ')}</span>`;
                
                const sourceParts = [];
                if (data.source_packaging > 0) sourceParts.push(`بسته‌بندی: ${data.source_packaging}`);
                if (data.source_warehouse > 0) sourceParts.push(`انبار: ${data.source_warehouse}`);
                if (data.source_production > 0) sourceParts.push(`حین تولید: ${data.source_production}`);
                if (sourceParts.length > 0) detailsFinalHTML += `<span><i class="bi bi-box-arrow-in-down icon-source"></i> ${sourceParts.join(' | ')}</span>`;

                if (data.defects_summary) detailsFinalHTML += `<span><i class="bi bi-card-text icon-defect"></i> ${data.defects_summary}</span>`;
                
                if (data.comments) detailsFinalHTML += `<span><i class="bi bi-chat-left-text"></i> ${data.comments}</span>`;

                contentHTML += `<div class="export-item-card"><div class="export-item-header"><h2 class="export-item-title">${index + 1}. ${data.part_name} - ${data.product_model}</h2><span class="export-item-count">تعداد: ${data.total_count}</span></div><div class="export-item-details">${detailsFinalHTML}</div></div>`;
            });
            contentHTML += `</div>`;
            
            const controlApprover = document.getElementById('approver-control').value.trim();
            const lineApprover = document.getElementById('approver-line').value.trim();
            const engApprover = document.getElementById('approver-eng').value.trim();

            if (controlApprover || lineApprover || engApprover) {
                let approvalHTML = `<div class="approvers-container" style="display: flex;"><h4></h4>`;
                approvalHTML += `<div class="approver-group"><label>1. نماینده کنترل:</label><span class="approver-group-name">${controlApprover || ' '}</span></div>`;
                approvalHTML += `<div class="approver-group"><label>2. نماینده تولید:</label><span class="approver-group-name">${lineApprover || ' '}</span></div>`;
                approvalHTML += `<div class="approver-group"><label>3. نماینده فنی و مهندسی:</label><span class="approver-group-name">${engApprover || ' '}</span></div>`;
                approvalHTML += `</div>`;
                contentHTML += approvalHTML;
            }

            exportContainer.innerHTML = contentHTML;

            const canvas = await html2canvas(exportContainer, { useCORS: true, scale: 2, backgroundColor: '#ffffff' });
            downloadFile(canvas.toDataURL('image/png'), `${fileName}.png`);

        } catch (err) {
            console.error("خطا در ایجاد تصویر:", err);
            alert("متاسفانه در ایجاد خروجی تصویر خطایی رخ داد.");
        } finally {
            document.body.removeChild(exportContainer);
            toggleButtonLoading(exportButton, false, `<i class="bi bi-camera-fill"></i> خروجی تصویر فرم`);
        }
    }

    function finalizeForm() {
        if (!validateAllForms()) {
            alert("لطفاً قبل از ثبت نهایی، تمام خطاهای فرم را برطرف کنید.");
            return;
        }

        const controlApprover = document.getElementById('approver-control');
        const lineApprover = document.getElementById('approver-line');
        const engApprover = document.getElementById('approver-eng');
        
        controlApprover.classList.remove('required-field-error');
        lineApprover.classList.remove('required-field-error');
        engApprover.classList.remove('required-field-error');

        let firstInvalidApprover = null;

        if (!controlApprover.value.trim()) firstInvalidApprover = controlApprover;
        else if (!lineApprover.value.trim()) firstInvalidApprover = lineApprover;
        else if (!engApprover.value.trim()) firstInvalidApprover = engApprover;
        
        if (firstInvalidApprover) {
            alert("برای ثبت نهایی، لطفاً نام تمام تایید کنندگان را وارد کنید.");
            firstInvalidApprover.classList.add('required-field-error');
            firstInvalidApprover.focus();
            return;
        }

        if (confirm("آیا از ثبت نهایی فرم اطمینان دارید؟ پس از تایید، امکان ویرایش وجود نخواهد داشت.")) {
            lockForm();
            alert("فرم با موفقیت ثبت و قفل شد. اکنون می‌توانید خروجی بگیرید.");
        }
    }
    
    function lockForm() {
        document.getElementById('main-container').classList.add('form-locked');
        document.querySelectorAll('input, select:not([name="part_name"])').forEach(el => el.disabled = true);
        
        if(mobilePartNameChoice) mobilePartNameChoice.disable();
        desktopPartNameChoices.forEach(choice => choice.disable());

        document.querySelectorAll('.action-btn, .delete-row-btn, .counter-btn').forEach(btn => {
            if (!btn.classList.contains('export-btn') && !btn.classList.contains('export-img-btn')) {
                btn.disabled = true;
            }
        });
        
        const finalizeBtn = document.querySelector('.finalize-btn');
        finalizeBtn.innerHTML = `<i class="bi bi-lock-fill"></i> نهایی شده`;
    }

    // --- HELPER & INTERNAL FUNCTIONS ---
    function createRowHTML(rowNumber) { 
        const groupOptions = `<option value="BVC">BVC</option><option value="CSC">CSC</option><option value="CSC-TL">CSC-TL</option><option value="DW-CSC">DW-CSC</option><option value="DW-TC">DW-TC</option><option value="KB">KB</option><option value="KVC">KVC</option><option value="TLX">TLX</option><option value="TT">TT</option><option value="VC">VC</option><option value="WM-KEN">WM-KEN</option><option value="سایر">سایر</option>`; 
        return ` <td class="row-number">${rowNumber}</td><td><input type="text" name="product_model" oninput="validateRowVisuals(this.closest('tr'))"></td><td><select name="group" onchange="validateRowVisuals(this.closest('tr'))">${groupOptions}</select></td><td><input type="number" name="item" oninput="validateRowVisuals(this.closest('tr'))"></td><td><select name="part_name"></select></td><td><input type="number" name="total_count" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="supplier_injection" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="supplier_press" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="supplier_internal" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="supplier_external" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="source_packaging" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="source_warehouse" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td><input type="number" name="source_production" oninput="validateRowVisuals(this.closest('tr'))" value="0"></td><td class="defects-summary-col"><input type="text" name="defects_summary" readonly></td><td><input type="text" name="comments"></td><td><button class="delete-row-btn" onclick="deleteRow(this)"><i class="bi bi-trash3-fill"></i></button></td> `; 
    }
    
    function updateMobileSummary() {
        mobileForm.summaryList.innerHTML = '';
        tableBody.querySelectorAll('tr').forEach((row, index) => {
            const partName = row.querySelector('[name="part_name"]').value;
            const totalCount = row.querySelector('[name="total_count"]').value;
            if (!partName || !totalCount || totalCount <= 0) return;
            const li = document.createElement('li');
            li.dataset.rowIndex = index;
            
            let detailsHTML = '';
            const supplierParts = [];
            if (row.querySelector('[name="supplier_injection"]').value > 0) supplierParts.push(`تزریق: ${row.querySelector('[name="supplier_injection"]').value}`);
            if (row.querySelector('[name="supplier_press"]').value > 0) supplierParts.push(`پرسکاری: ${row.querySelector('[name="supplier_press"]').value}`);
            if (row.querySelector('[name="supplier_internal"]').value > 0) supplierParts.push(`داخلی: ${row.querySelector('[name="supplier_internal"]').value}`);
            if (row.querySelector('[name="supplier_external"]').value > 0) supplierParts.push(`خارجی: ${row.querySelector('[name="supplier_external"]').value}`);
            if (supplierParts.length > 0) {
                detailsHTML += `<span><i class="bi bi-person-fill icon-supplier"></i> ${supplierParts.join('، ')}</span>`;
            }

            const sourceParts = [];
            if (row.querySelector('[name="source_packaging"]').value > 0) sourceParts.push(`بسته‌بندی: ${row.querySelector('[name="source_packaging"]').value}`);
            if (row.querySelector('[name="source_warehouse"]').value > 0) sourceParts.push(`انبار: ${row.querySelector('[name="source_warehouse"]').value}`);
            if (row.querySelector('[name="source_production"]').value > 0) sourceParts.push(`حین تولید: ${row.querySelector('[name="source_production"]').value}`);
            if (sourceParts.length > 0) {
                 detailsHTML += `<span><i class="bi bi-box-arrow-in-down icon-source"></i> ${sourceParts.join('، ')}</span>`;
            }

            const defectsText = row.querySelector('[name="defects_summary"]').value;
            if(defectsText){
                detailsHTML += `<span><i class="bi bi-card-text icon-defect"></i> ${defectsText}</span>`;
            }
            
            li.innerHTML = `<div class="summary-main-row"><span class="summary-text">${index + 1}. ${partName}</span><span class="summary-count">تعداد: ${totalCount}</span></div><div class="summary-details">${detailsHTML}</div>`;
            
            mobileForm.summaryList.appendChild(li);
        });
    }

    function resetMobileForm() {
        document.querySelectorAll('#mobile-form-wrapper [data-required-name]').forEach(el => {
            const container = el.id === 'mobile-part-name' ? el.closest('.mobile-form-group') : (el.closest('.counter-input-group') || el);
            if(container) container.classList.remove('required-field-error');
        });
        mobilePartNameChoice.setChoiceByValue('');
        Object.keys(mobileForm).forEach(key => {
            const el = mobileForm[key];
            if (el && el.tagName && key !== 'partName') {
                if (key === 'productModel' || key === 'group' || key === 'item') {} 
                else if (el.type === 'number') {
                    el.value = key === 'totalCount' ? 1 : (el.min || 0);
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else if (el.type === 'text' || el.type === 'textarea') {
                    el.value = '';
                }
            }
        });
        
        if (defaultProductModel) {
            mobileForm.productModel.value = defaultProductModel;
            mobileForm.group.value = defaultGroup;
            mobileForm.item.value = defaultItem;
        }

        mobilePartNameChoice.hideDropdown();
        mobileForm.totalCount.focus();
    }
    
    function updateAllPartNameDropdowns() {
        const productType = productTypeSelect.value;
        const newParts = allPartLists[productType] || [];
        const choicesArray = [
            { value: '', label: 'انتخاب قطعه...', placeholder: true, disabled: true }
        ].concat(newParts.map(name => ({ value: name, label: name })));

        if (mobilePartNameChoice) {
            const currentVal = mobilePartNameChoice.getValue(true);
            mobilePartNameChoice.setChoices(choicesArray, 'value', 'label', true);
             if (newParts.includes(currentVal)) {
                mobilePartNameChoice.setChoiceByValue(currentVal);
            }
        }

        desktopPartNameChoices.forEach((choiceInstance) => {
            const currentVal = choiceInstance.getValue(true);
            choiceInstance.setChoices(choicesArray, 'value', 'label', true);
            if (newParts.includes(currentVal)) {
                choiceInstance.setChoiceByValue(currentVal);
            }
        });
    }
    
    function getValidationStatus(data, rowIndex = '') {
        const requiredFields = { part_name: 'نام قطعه', total_count: 'تعداد کل', product_model: 'مدل محصول', group: 'گروه', item: 'آیتم', defects_summary: 'شرح ضایعات' };
        for (const field in requiredFields) {
            if (!data[field] || (field === 'total_count' && parseInt(data[field], 10) === 0)) return { isValid: false, message: `فیلد "${requiredFields[field]}" در ${rowIndex ? `ردیف ${rowIndex}` : 'فرم'} اجباری است و نمی‌تواند صفر باشد.` };
        }
        const totalCount = parseInt(data.total_count, 10) || 0;
        const supplierSum = ['supplier_injection', 'supplier_press', 'supplier_internal', 'supplier_external'].reduce((sum, key) => sum + (parseInt(data[key], 10) || 0), 0);
        if (supplierSum !== totalCount) return { isValid: false, message: `مجموع تامین‌کننده (${supplierSum}) با تعداد کل (${totalCount}) در ${rowIndex ? `ردیف ${rowIndex}` : 'فرم'} برابر نیست.` };
        const sourceSum = ['source_packaging', 'source_warehouse', 'source_production'].reduce((sum, key) => sum + (parseInt(data[key], 10) || 0), 0);
        if (sourceSum !== totalCount) return { isValid: false, message: `مجموع منشا ضایعات (${sourceSum}) با تعداد کل (${totalCount}) در ${rowIndex ? `ردیف ${rowIndex}` : 'فرم'} برابر نیست.` };
        return { isValid: true };
    }

    function validateAllForms() {
        const { globalDate, globalLine, globalProductType } = getGlobalData();
        const dateInput = document.getElementById('jalali_date'), lineSelect = document.getElementById('line'), productTypeSelect = document.getElementById('product_type');
        [dateInput, lineSelect, productTypeSelect].forEach(el => el.classList.remove('required-field-error'));
        let firstInvalidElement = null;
        if (!globalDate) { dateInput.classList.add('required-field-error'); firstInvalidElement = firstInvalidElement || dateInput; }
        if (!globalLine) { lineSelect.classList.add('required-field-error'); firstInvalidElement = firstInvalidElement || lineSelect; }
        if (!globalProductType) { productTypeSelect.classList.add('required-field-error'); firstInvalidElement = firstInvalidElement || productTypeSelect; }
        if (firstInvalidElement) { alert("لطفا فیلدهای اصلی بالای فرم (تاریخ، خط، نوع محصول) را تکمیل کنید."); firstInvalidElement.focus(); return false; }

        if (tableBody.rows.length === 0 || (tableBody.rows.length === 1 && !tableBody.rows[0].querySelector('[name="part_name"]').value)) { alert("هیچ داده‌ای برای ثبت یا تایید وجود ندارد."); return false; }
        for (const row of tableBody.rows) {
             const data = Object.fromEntries(Array.from(row.querySelectorAll('input, select')).map(el => [el.name, el.value]));
             if (!data.part_name) continue;
            const status = getValidationStatus(data, row.rowIndex + 1);
            if (!status.isValid) { alert(status.message); setActiveRow(row); row.scrollIntoView({ behavior: 'smooth', block: 'center' }); return false; }
        }
        return true;
    }
    
    function validateRowVisuals(row) {
         if (!row || !row.querySelector) return;
         const data = Object.fromEntries(Array.from(row.querySelectorAll('input, select')).map(el => [el.name, el.value]));
         row.classList.toggle('invalid-row', !getValidationStatus(data).isValid);
    }
    
    function setActiveRow(row) { if(activeRow) activeRow.classList.remove('active-row'); activeRow = row; if(activeRow) activeRow.classList.add('active-row'); }
    function updateRowNumbers() { tableBody.querySelectorAll('tr .row-number').forEach((td, index) => { td.textContent = index + 1; }); }
    
    function relocateLegends() { 
        legendsContainer.style.display = 'block';
        if (window.innerWidth < 992) { mobileLegendsWrapper.appendChild(legendsContainer); } 
        else { desktopLegendsWrapper.appendChild(legendsContainer); }
    }
    
    function updateDefectCount(defectName, changeAmount) {
        if (document.getElementById('main-container').classList.contains('form-locked')) return;
        const isMobileView = document.getElementById('mobile-form-wrapper').offsetParent !== null;
        let targetInput = isMobileView ? mobileForm.defectsSummary : (activeRow ? activeRow.querySelector('[name="defects_summary"]') : null);
        if (!targetInput) { if (!isMobileView) alert("لطفاً ابتدا یک ردیف را در جدول انتخاب کنید."); return; }
        const defectsMap = new Map((targetInput.value.split(' | ').map(part => part.split(': ')).filter(p => p.length === 2).map(([k, v]) => [k.trim(), parseInt(v.trim(), 10)])));
        const newCount = (defectsMap.get(defectName) || 0) + changeAmount;
        if (newCount > 0) defectsMap.set(defectName, newCount); else defectsMap.delete(defectName);
        targetInput.value = Array.from(defectsMap, ([text, count]) => `${text}: ${count}`).join(' | ');
        if (!isMobileView && activeRow) validateRowVisuals(activeRow);
    }

    function getGlobalData() {
        const wasteTypeEl = document.querySelector('input[name="waste_type"]:checked');
        return { globalDate: document.getElementById('jalali_date').value.trim(), globalLine: document.getElementById('line').value, globalProductType: document.getElementById('product_type').value, wasteType: wasteTypeEl ? wasteTypeEl.value : '' };
    }

    function downloadFile(content, fileName, contentType) {
        const link = document.createElement("a");
        const url = (contentType) ? URL.createObjectURL(new Blob([content], { type: contentType })) : content;
        link.href = url;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        if (contentType) URL.revokeObjectURL(url);
    }

    function toggleButtonLoading(button, isLoading, text) {
        button.disabled = isLoading;
        button.innerHTML = text;
    }


    // --- SCRIPT INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        tableBody = document.getElementById('main-table-body');
        productTypeSelect = document.getElementById('product_type');
        legendsContainer = document.getElementById('legends-container');
        desktopLegendsWrapper = document.getElementById('desktop-legends-wrapper');
        mobileLegendsWrapper = document.getElementById('mobile-legends-wrapper');
        mobileForm = { 
            partName: document.getElementById('mobile-part-name'),
            totalCount: document.getElementById('mobile-total-count'), 
            productModel: document.getElementById('mobile-product-model'), 
            group: document.getElementById('mobile-group'), 
            item: document.getElementById('mobile-item'), 
            supplierInjection: document.getElementById('mobile-supplier-injection'), 
            supplierPress: document.getElementById('mobile-supplier-press'), 
            supplierInternal: document.getElementById('mobile-supplier-internal'), 
            supplierExternal: document.getElementById('mobile-supplier-external'), 
            sourcePackaging: document.getElementById('mobile-source-packaging'), 
            sourceWarehouse: document.getElementById('mobile-source-warehouse'), 
            sourceProduction: document.getElementById('mobile-source-production'), 
            defectsSummary: document.getElementById('mobile-defects-summary'), 
            comments: document.getElementById('mobile-comments'), 
            addBtn: document.getElementById('mobile-add-btn'), 
            summaryList: document.getElementById('mobile-summary-list') 
        };

        mobilePartNameChoice = new Choices(mobileForm.partName, choicesConfig);
        mobileForm.partName.addEventListener('change', () => {
            mobileForm.partName.closest('.mobile-form-group').classList.remove('required-field-error');
        });
        
        tableBody.addEventListener('click', (event) => { if(document.getElementById('main-container').classList.contains('form-locked')) return; const row = event.target.closest('tr'); if (row) setActiveRow(row); });
        document.addEventListener('click', (event) => {
            if (document.getElementById('main-container').classList.contains('form-locked')) return;
            if (event.target.closest('th[data-target-name]')) {
                const header = event.target.closest('th[data-target-name]');
                if (!header || !activeRow) return;
                const targetName = header.getAttribute('data-target-name');
                const targetInput = activeRow.querySelector(`input[name="${targetName}"]`);
                if (targetInput) { targetInput.value = (parseInt(targetInput.value, 10) || 0) + 1; validateRowVisuals(activeRow); }
            }
        });
        let touchTimer, isLongPress = false;
        legendsContainer.addEventListener('touchstart', (event) => { const item = event.target.closest('li[data-defect-name]'); if (item) { isLongPress = false; touchTimer = setTimeout(() => { isLongPress = true; updateDefectCount(item.dataset.defectName, -1); navigator.vibrate?.(50); }, 500); } });
        legendsContainer.addEventListener('touchend', (e) => { clearTimeout(touchTimer); if (isLongPress) e.preventDefault(); });
        legendsContainer.addEventListener('touchmove', () => clearTimeout(touchTimer));
        legendsContainer.addEventListener('click', (e) => { const item = e.target.closest('li[data-defect-name]'); if (item && !isLongPress) updateDefectCount(item.dataset.defectName, 1); });
        legendsContainer.addEventListener('contextmenu', (e) => { const item = e.target.closest('li[data-defect-name]'); if (item) { e.preventDefault(); updateDefectCount(item.dataset.defectName, -1); } });
        
        mobileForm.addBtn.addEventListener('click', () => {
            const requiredElements = document.querySelectorAll('#mobile-form-wrapper [data-required-name]');
            let firstInvalidElement = null;
            
            requiredElements.forEach(el => {
                const container = el.id === 'mobile-part-name' ? el.closest('.mobile-form-group') : (el.closest('.counter-input-group') || el);
                if(container) container.classList.remove('required-field-error');
            });

            for (const el of requiredElements) { 
                if (!el.value || (el.id === 'mobile-total-count' && el.value === '0')) { 
                    const container = el.id === 'mobile-part-name' ? el.closest('.mobile-form-group') : (el.closest('.counter-input-group') || el);
                    if(container) container.classList.add('required-field-error'); 
                    if (!firstInvalidElement) firstInvalidElement = el; 
                } 
            }

            if (firstInvalidElement) { 
                alert(`لطفا فیلد "${firstInvalidElement.dataset.requiredName}" را پر کنید.`); 
                if (firstInvalidElement.id === 'mobile-part-name') {
                    mobilePartNameChoice.showDropdown();
                } else {
                    firstInvalidElement.focus();
                }
                const accordionContent = firstInvalidElement.closest('.accordion-content'); 
                if(accordionContent) { accordionContent.style.display = 'flex'; accordionContent.previousElementSibling.classList.add('active'); } 
                return; 
            }
            
            const mobileData = { product_model: mobileForm.productModel.value, group: mobileForm.group.value, item: mobileForm.item.value, part_name: mobileForm.partName.value, total_count: mobileForm.totalCount.value, supplier_injection: mobileForm.supplierInjection.value, supplier_press: mobileForm.supplierPress.value, supplier_internal: mobileForm.supplierInternal.value, supplier_external: mobileForm.supplierExternal.value, source_packaging: mobileForm.sourcePackaging.value, source_warehouse: mobileForm.sourceWarehouse.value, source_production: mobileForm.sourceProduction.value, defects_summary: mobileForm.defectsSummary.value, comments: mobileForm.comments.value, };
            
            const status = getValidationStatus(mobileData);
            if (!status.isValid) { alert(status.message); return; }

            if (!defaultProductModel) {
                defaultProductModel = mobileData.product_model;
                defaultGroup = mobileData.group;
                defaultItem = mobileData.item;
            }

            addRow(mobileData);
            updateMobileSummary();
            resetMobileForm();
        });

        document.getElementById('mobile-form-wrapper').addEventListener('click', (e) => {
            if (document.getElementById('main-container').classList.contains('form-locked')) return;
            if (e.target.matches('.counter-btn')) {
                const targetInput = document.getElementById(e.target.dataset.target);
                if (targetInput) { let value = parseInt(targetInput.value, 10) || 0; const min = parseInt(targetInput.min, 10); if (e.target.classList.contains('plus-btn')) value++; else if (value > (isNaN(min) ? 0 : min)) value--; targetInput.value = value; }
            }
        });

        let mobileDeleteTimer;
        const summaryList = document.getElementById('mobile-summary-list');
        const cancelMobileDelete = (e) => {
            clearTimeout(mobileDeleteTimer);
            const li = summaryList.querySelector('li.deleting');
            if (li) li.classList.remove('deleting');
        };

        summaryList.addEventListener('touchstart', (e) => {
            if (document.getElementById('main-container').classList.contains('form-locked')) return;
            const li = e.target.closest('li[data-row-index]');
            if (!li) return;
            li.classList.add('deleting');
            mobileDeleteTimer = setTimeout(() => {
                navigator.vibrate?.(100);
                if (confirm(`آیا از حذف قطعه "${li.querySelector('.summary-text').textContent.trim()}" اطمینان دارید؟`)) {
                    const rowIndex = parseInt(li.dataset.rowIndex, 10);
                    const rowToDelete = tableBody.rows[rowIndex];
                    if (rowToDelete) {
                        const deleteBtn = rowToDelete.querySelector('.delete-row-btn');
                        if (deleteBtn) deleteRow(deleteBtn);
                    }
                }
                li.classList.remove('deleting');
            }, 3000);
        });

        summaryList.addEventListener('touchend', cancelMobileDelete);
        summaryList.addEventListener('touchcancel', cancelMobileDelete);
        summaryList.addEventListener('touchmove', cancelMobileDelete);

        productTypeSelect.addEventListener('change', () => { updateAllPartNameDropdowns(); });
        document.querySelectorAll('.accordion-header').forEach(header => { header.addEventListener('click', () => { if (document.getElementById('main-container').classList.contains('form-locked')) return; header.classList.toggle('active'); const content = header.nextElementSibling; content.style.display = content.style.display === 'flex' ? 'none' : 'flex'; }); });
        window.addEventListener('resize', relocateLegends);
        ['jalali_date', 'line', 'product_type', 'approver-control', 'approver-line', 'approver-eng'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', (e) => e.target.classList.remove('required-field-error'));
        });
        
        relocateLegends();

        const dateInput = document.getElementById('jalali_date');
        const today = new Date();
        const formatter = new Intl.DateTimeFormat('fa-IR-u-nu-latn', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            calendar: 'persian'
        });
        dateInput.value = formatter.format(today);
        jdp.render(dateInput, { usePersianDigits: true, format: 'YYYY/MM/DD' });

        updateAllPartNameDropdowns();
        if(document.documentElement.clientWidth >= 992) addRow();
    });
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>

</body>
</html>